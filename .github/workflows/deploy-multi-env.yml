name: Deploy PDFShift (Multi Environment)

on:
  push:
    branches:
      - develop      # ä»…æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging
      confirm_production:
        description: 'ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç¡®è®¤ (è¾“å…¥ DEPLOY ç¡®è®¤)'
        required: false
        type: string
        default: ''

jobs:
  # ========== é¢„æ£€æŸ¥ä»»åŠ¡ ==========
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine.outputs.environment }}
      deploy_path: ${{ steps.determine.outputs.deploy_path }}
      api_port: ${{ steps.determine.outputs.api_port }}
      service_prefix: ${{ steps.determine.outputs.service_prefix }}
      should_deploy: ${{ steps.validate.outputs.should_deploy }}

    steps:
      - name: Determine environment
        id: determine
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
            echo "ğŸ¯ æ‰‹åŠ¨è§¦å‘éƒ¨ç½²: $ENV"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            ENV="staging"
            echo "ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ"
          else
            echo "âŒ æœªçŸ¥åˆ†æ”¯æˆ–è§¦å‘æ–¹å¼"
            exit 1
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

          # è®¾ç½®ç¯å¢ƒç‰¹å®šé…ç½®
          if [ "$ENV" == "production" ]; then
            echo "deploy_path=/opt/pdfshift/production" >> $GITHUB_OUTPUT
            echo "api_port=8000" >> $GITHUB_OUTPUT
            echo "service_prefix=pdfshift-production" >> $GITHUB_OUTPUT
          else
            echo "deploy_path=/opt/pdfshift/staging" >> $GITHUB_OUTPUT
            echo "api_port=8001" >> $GITHUB_OUTPUT
            echo "service_prefix=pdfshift-staging" >> $GITHUB_OUTPUT
          fi

      - name: Validate production deployment
        id: validate
        run: |
          ENV="${{ steps.determine.outputs.environment }}"

          if [ "$ENV" == "production" ]; then
            CONFIRM="${{ github.event.inputs.confirm_production }}"

            echo "========================================="
            echo "  âš ï¸  ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç¡®è®¤"
            echo "========================================="
            echo "ç¯å¢ƒ: $ENV"
            echo "åˆ†æ”¯: ${{ github.ref_name }}"
            echo "æäº¤: ${{ github.sha }}"
            echo "æ“ä½œäºº: ${{ github.actor }}"
            echo "ç¡®è®¤è¾“å…¥: $CONFIRM"
            echo "========================================="

            if [ "$CONFIRM" != "DEPLOY" ]; then
              echo ""
              echo "âŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éœ€è¦ç¡®è®¤ï¼"
              echo "   è¯·åœ¨ workflow è¾“å…¥æ¡†ä¸­è¾“å…¥: DEPLOY"
              echo ""
              exit 1
            fi

            echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å·²ç¡®è®¤"
          fi

          echo "should_deploy=true" >> $GITHUB_OUTPUT

  # ========== æ„å»ºå’Œéƒ¨ç½²ä»»åŠ¡ ==========
  deploy:
    needs: pre-check
    runs-on: ubuntu-latest
    if: needs.pre-check.outputs.should_deploy == 'true'

    environment:
      name: ${{ needs.pre-check.outputs.environment }}
      url: ${{ needs.pre-check.outputs.environment == 'production' && 'https://coreshift.cn' || 'https://test.coreshift.cn' }}

    steps:
      # ========== 1. æ£€å‡ºä»£ç  ==========
      - name: Checkout code
        uses: actions/checkout@v4

      # ========== 2. æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯ ==========
      - name: Display deployment info
        run: |
          echo "========================================="
          echo "  éƒ¨ç½²ä¿¡æ¯"
          echo "========================================="
          echo "ç¯å¢ƒ:        ${{ needs.pre-check.outputs.environment }}"
          echo "åˆ†æ”¯:        ${{ github.ref_name }}"
          echo "æäº¤:        ${{ github.sha }}"
          echo "æäº¤è€…:      ${{ github.actor }}"
          echo "è§¦å‘æ–¹å¼:    ${{ github.event_name }}"
          echo "éƒ¨ç½²è·¯å¾„:    ${{ needs.pre-check.outputs.deploy_path }}"
          echo "API ç«¯å£:    ${{ needs.pre-check.outputs.api_port }}"
          echo "========================================="

      # ========== 3. è®¾ç½® Node.js ==========
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # ç§»é™¤ç¼“å­˜é…ç½®ä»¥é¿å…è·¯å¾„è§£æé—®é¢˜
          # cache: 'npm'
          # cache-dependency-path: frontend/package-lock.json

      # ========== 4. æ„å»ºå‰ç«¯ ==========
      - name: Build frontend
        run: |
          cd frontend
          npm ci --legacy-peer-deps

          # æ ¹æ®ç¯å¢ƒè®¾ç½®æ„å»ºå˜é‡
          if [ "${{ needs.pre-check.outputs.environment }}" == "production" ]; then
            export VITE_API_BASE_URL=https://coreshift.cn/api
            export VITE_APP_ENV=production
          else
            export VITE_API_BASE_URL=https://test.coreshift.cn/api
            export VITE_APP_ENV=staging
          fi

          npm run build

          echo ""
          echo "âœ… Frontend build completed"
          echo "Environment: ${{ needs.pre-check.outputs.environment }}"
          echo "Build size: $(du -sh dist | cut -f1)"

      # ========== 5. æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶ ==========
      - name: Package deployment files
        run: |
          mkdir -p deploy_package

          # å¤åˆ¶åç«¯ä»£ç 
          cp -r backend deploy_package/

          # å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
          mkdir -p deploy_package/frontend
          cp -r frontend/dist deploy_package/frontend/

          # æ·»åŠ ç¯å¢ƒæ ‡è¯†æ–‡ä»¶
          echo "${{ needs.pre-check.outputs.environment }}" > deploy_package/ENVIRONMENT
          echo "${{ github.sha }}" > deploy_package/VERSION

          # æ‰“åŒ…
          tar -czf deploy.tar.gz deploy_package/

          echo "âœ… Package created"
          echo "Package size: $(du -h deploy.tar.gz | cut -f1)"

      # ========== 6. ä¸Šä¼ åˆ° ECS ==========
      - name: Upload to ECS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USERNAME }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp"
          timeout: 60s

      # ========== 7. éƒ¨ç½²åˆ°æœåŠ¡å™¨ ==========
      - name: Deploy to ${{ needs.pre-check.outputs.environment }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USERNAME }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            set -e

            ENV="${{ needs.pre-check.outputs.environment }}"
            DEPLOY_PATH="${{ needs.pre-check.outputs.deploy_path }}"
            SERVICE_PREFIX="${{ needs.pre-check.outputs.service_prefix }}"
            API_PORT="${{ needs.pre-check.outputs.api_port }}"

            echo "========================================="
            echo "  å¼€å§‹éƒ¨ç½²: $ENV"
            echo "  æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "========================================="

            # è§£å‹éƒ¨ç½²åŒ…
            echo ""
            echo "ğŸ“¦ è§£å‹éƒ¨ç½²åŒ…..."
            cd /tmp
            tar -xzf deploy.tar.gz

            # éªŒè¯ç¯å¢ƒ
            PACKAGE_ENV=$(cat deploy_package/ENVIRONMENT)
            if [ "$PACKAGE_ENV" != "$ENV" ]; then
              echo "âŒ ç¯å¢ƒä¸åŒ¹é…: åŒ…=$PACKAGE_ENV, ç›®æ ‡=$ENV"
              exit 1
            fi
            echo "âœ… ç¯å¢ƒéªŒè¯é€šè¿‡: $ENV"

            # å¤‡ä»½æ•°æ®åº“
            echo ""
            echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
            DB_FILE="$DEPLOY_PATH/data/${ENV}.db"
            if [ -f "$DB_FILE" ]; then
              BACKUP_FILE="$DEPLOY_PATH/backups/${ENV}.db.$(date +%Y%m%d_%H%M%S)"
              sudo -u www-data cp "$DB_FILE" "$BACKUP_FILE"
              echo "âœ… æ•°æ®åº“å·²å¤‡ä»½: $(basename $BACKUP_FILE)"
              echo "   å¤§å°: $(du -h $BACKUP_FILE | cut -f1)"
            else
              echo "âš ï¸  æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
            fi

            # åœæ­¢æœåŠ¡
            echo ""
            echo "ğŸ›‘ åœæ­¢ $ENV æœåŠ¡..."
            sudo systemctl stop ${SERVICE_PREFIX}-api || true
            sudo systemctl stop ${SERVICE_PREFIX}-worker || true
            sudo systemctl stop ${SERVICE_PREFIX}-beat || true
            sleep 2
            echo "âœ… æœåŠ¡å·²åœæ­¢"

            # å¤‡ä»½æ—§ä»£ç 
            echo ""
            echo "ğŸ“‚ å¤‡ä»½æ—§ä»£ç ..."
            if [ -d "$DEPLOY_PATH/backend" ]; then
              sudo rm -rf $DEPLOY_PATH/backend.old
              sudo mv $DEPLOY_PATH/backend $DEPLOY_PATH/backend.old
            fi
            if [ -d "$DEPLOY_PATH/frontend/dist" ]; then
              sudo rm -rf $DEPLOY_PATH/frontend/dist.old
              sudo mv $DEPLOY_PATH/frontend/dist $DEPLOY_PATH/frontend/dist.old
            fi

            # æ›´æ–°åç«¯ä»£ç 
            echo ""
            echo "ğŸ“ æ›´æ–°åç«¯ä»£ç ..."
            sudo cp -r /tmp/deploy_package/backend $DEPLOY_PATH/
            sudo chown -R www-data:www-data $DEPLOY_PATH/backend
            echo "âœ… åç«¯ä»£ç å·²æ›´æ–°"

            # æ›´æ–°å‰ç«¯ä»£ç 
            echo ""
            echo "ğŸ¨ æ›´æ–°å‰ç«¯ä»£ç ..."
            sudo mkdir -p $DEPLOY_PATH/frontend
            sudo cp -r /tmp/deploy_package/frontend/dist $DEPLOY_PATH/frontend/
            sudo chown -R www-data:www-data $DEPLOY_PATH/frontend
            echo "âœ… å‰ç«¯ä»£ç å·²æ›´æ–°"

            # æ›´æ–° Python ä¾èµ–
            echo ""
            echo "ğŸ“š æ›´æ–° Python ä¾èµ–..."
            cd $DEPLOY_PATH/backend

            if [ -f requirements.txt ]; then
              # ä½¿ç”¨é˜¿é‡Œäº‘ PyPI é•œåƒæºï¼Œå¢åŠ è¶…æ—¶æ—¶é—´å’Œé‡è¯•æ¬¡æ•°
              sudo -u www-data $DEPLOY_PATH/venv/bin/pip install \
                -r requirements.txt \
                --upgrade \
                --index-url https://mirrors.aliyun.com/pypi/simple/ \
                --trusted-host mirrors.aliyun.com \
                --timeout 300 \
                --retries 5
              echo "âœ… Python ä¾èµ–å·²æ›´æ–°"
            else
              echo "âš ï¸  æœªæ‰¾åˆ° requirements.txt"
            fi

            # æ•°æ®åº“è¿ç§»
            echo ""
            echo "ğŸ—„ï¸  æ£€æŸ¥æ•°æ®åº“è¿ç§»..."
            if [ -f migrate.py ]; then
              sudo -u www-data $DEPLOY_PATH/venv/bin/python migrate.py
              echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"
            else
              echo "â„¹ï¸  æ— éœ€æ•°æ®åº“è¿ç§»"
            fi

            # å¯åŠ¨æœåŠ¡
            echo ""
            echo "ğŸš€ å¯åŠ¨ $ENV æœåŠ¡..."
            sudo systemctl start ${SERVICE_PREFIX}-api
            sudo systemctl start ${SERVICE_PREFIX}-worker
            sudo systemctl start ${SERVICE_PREFIX}-beat

            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 5

            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo ""
            echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."

            API_STATUS=$(sudo systemctl is-active ${SERVICE_PREFIX}-api)
            WORKER_STATUS=$(sudo systemctl is-active ${SERVICE_PREFIX}-worker)
            BEAT_STATUS=$(sudo systemctl is-active ${SERVICE_PREFIX}-beat || echo "inactive")

            echo "  - API:    $API_STATUS"
            echo "  - Worker: $WORKER_STATUS"
            echo "  - Beat:   $BEAT_STATUS"

            if [ "$API_STATUS" != "active" ]; then
              echo ""
              echo "âŒ API æœåŠ¡å¯åŠ¨å¤±è´¥"
              sudo journalctl -u ${SERVICE_PREFIX}-api -n 50 --no-pager
              exit 1
            fi

            if [ "$WORKER_STATUS" != "active" ]; then
              echo "âš ï¸  Worker æœåŠ¡å¼‚å¸¸"
              sudo journalctl -u ${SERVICE_PREFIX}-worker -n 20 --no-pager
            fi

            # å¥åº·æ£€æŸ¥
            echo ""
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."

            MAX_RETRIES=10
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -sf http://localhost:${API_PORT}/health > /dev/null 2>&1; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT+1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "â³ é‡è¯•ä¸­... ($RETRY_COUNT/$MAX_RETRIES)"
                  sleep 3
                else
                  echo ""
                  echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
                  sudo journalctl -u ${SERVICE_PREFIX}-api -n 50 --no-pager
                  exit 1
                fi
              fi
            done

            # æµ‹è¯•å…³é”®ç«¯ç‚¹
            echo ""
            echo "ğŸ§ª æµ‹è¯• API ç«¯ç‚¹..."

            # æµ‹è¯•å‰ç«¯
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${API_PORT}/ || echo "000")
            echo "  - å‰ç«¯é¡µé¢: HTTP $HTTP_CODE"

            # æµ‹è¯• API
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${API_PORT}/api/v1/health || echo "000")
            echo "  - API å¥åº·: HTTP $HTTP_CODE"

            # ç³»ç»Ÿèµ„æº
            echo ""
            echo "ğŸ’» ç³»ç»Ÿèµ„æº:"
            echo "  - CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')%"
            echo "  - å†…å­˜: $(free -h | awk '/^Mem:/ {print $3 "/" $2}')"
            echo "  - ç£ç›˜: $(df -h $DEPLOY_PATH | awk 'NR==2 {print $3 "/" $2 " (" $5 ")"}')"

            # æœåŠ¡ç«¯å£ç›‘å¬
            echo ""
            echo "ğŸ”Œ æœåŠ¡ç«¯å£:"
            ss -tlnp | grep ":${API_PORT}" || echo "  - è­¦å‘Š: ç«¯å£ ${API_PORT} æœªç›‘å¬"

            # æ¸…ç†
            echo ""
            echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            rm -rf /tmp/deploy.tar.gz /tmp/deploy_package

            # æ¸…ç†æ—§å¤‡ä»½
            cd $DEPLOY_PATH/backups
            ls -t ${ENV}.db.* 2>/dev/null | tail -n +6 | xargs -r rm -f
            echo "âœ… æ¸…ç†å®Œæˆï¼ˆä¿ç•™æœ€è¿‘ 5 ä¸ªå¤‡ä»½ï¼‰"

            # å®Œæˆ
            echo ""
            echo "========================================="
            echo "  âœ… $ENV ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
            echo "  æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "  ç‰ˆæœ¬: ${{ github.sha }}"
            echo "========================================="

      # ========== 8. éƒ¨ç½²æ‘˜è¦ ==========
      - name: Deployment summary
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "  éƒ¨ç½²æ‘˜è¦"
          echo "========================================="
          echo "ç¯å¢ƒ:     ${{ needs.pre-check.outputs.environment }}"
          echo "çŠ¶æ€:     ${{ job.status }}"
          echo "åˆ†æ”¯:     ${{ github.ref_name }}"
          echo "æäº¤:     ${{ github.sha }}"
          echo "æ“ä½œäºº:   ${{ github.actor }}"
          echo "æ—¶é—´:     $(date '+%Y-%m-%d %H:%M:%S')"

          if [ "${{ needs.pre-check.outputs.environment }}" == "production" ]; then
            echo "è®¿é—®åœ°å€: https://coreshift.cn"
            echo "ç®¡ç†åå°: https://coreshift.cn/admin"
          else
            echo "è®¿é—®åœ°å€: https://test.coreshift.cn"
            echo "ç®¡ç†åå°: https://test.coreshift.cn/admin"
          fi
          echo "========================================="

      # ========== 9. å¤±è´¥æ—¶å›æ»šï¼ˆå¯é€‰ï¼‰==========
      - name: Rollback on failure
        if: failure() && needs.pre-check.outputs.environment == 'production'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USERNAME }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: 22
          script: |
            echo "========================================="
            echo "  âš ï¸  ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š"
            echo "========================================="

            DEPLOY_PATH="/opt/pdfshift/production"
            SERVICE_PREFIX="pdfshift-production"

            # åœæ­¢æœåŠ¡
            sudo systemctl stop ${SERVICE_PREFIX}-api || true
            sudo systemctl stop ${SERVICE_PREFIX}-worker || true

            # æ¢å¤æ—§ä»£ç 
            if [ -d "$DEPLOY_PATH/backend.old" ]; then
              sudo rm -rf $DEPLOY_PATH/backend
              sudo mv $DEPLOY_PATH/backend.old $DEPLOY_PATH/backend
              echo "âœ… åç«¯ä»£ç å·²å›æ»š"
            fi

            if [ -d "$DEPLOY_PATH/frontend/dist.old" ]; then
              sudo rm -rf $DEPLOY_PATH/frontend/dist
              sudo mv $DEPLOY_PATH/frontend/dist.old $DEPLOY_PATH/frontend/dist
              echo "âœ… å‰ç«¯ä»£ç å·²å›æ»š"
            fi

            # é‡å¯æœåŠ¡
            sudo systemctl start ${SERVICE_PREFIX}-api
            sudo systemctl start ${SERVICE_PREFIX}-worker

            echo "âœ… å›æ»šå®Œæˆ"
