name: Deploy PDFShift (Lite - No Docker)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DEPLOY_PATH: /opt/pdfshift
  VENV_PATH: /opt/pdfshift/venv

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ========== 1. æ£€å‡ºä»£ç  ==========
      - name: Checkout code
        uses: actions/checkout@v4

      # ========== 2. è®¾ç½® Node.js ç¯å¢ƒ ==========
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # ========== 3. æ„å»ºå‰ç«¯ ==========
      - name: Build frontend
        run: |
          cd frontend
          npm ci --legacy-peer-deps
          npm run build

          echo "âœ… Frontend build completed"
          echo "Build size: $(du -sh dist | cut -f1)"
          ls -lh dist/

      # ========== 4. æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶ ==========
      - name: Package deployment files
        run: |
          mkdir -p deploy_package

          # å¤åˆ¶åç«¯ä»£ç 
          cp -r backend deploy_package/

          # å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
          mkdir -p deploy_package/frontend
          cp -r frontend/dist deploy_package/frontend/

          # æ‰“åŒ…
          tar -czf deploy.tar.gz deploy_package/

          echo "âœ… Package created"
          echo "Package size: $(du -h deploy.tar.gz | cut -f1)"

      # ========== 5. ä¸Šä¼ åˆ° ECS ==========
      - name: Upload to ECS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USERNAME }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp"

      # ========== 6. éƒ¨ç½²åˆ°æœåŠ¡å™¨ ==========
      - name: Deploy and restart services
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USERNAME }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            set -e

            echo "========================================="
            echo "  å¼€å§‹éƒ¨ç½² PDFShift"
            echo "  æ—¶é—´: $(date)"
            echo "========================================="

            # ========== è§£å‹æ–‡ä»¶ ==========
            echo ""
            echo "ğŸ“¦ è§£å‹éƒ¨ç½²åŒ…..."
            cd /tmp
            tar -xzf deploy.tar.gz
            echo "âœ… è§£å‹å®Œæˆ"

            # ========== å¤‡ä»½æ•°æ®åº“ ==========
            echo ""
            echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
            if [ -f "${{ env.DEPLOY_PATH }}/data/pdfshift.db" ]; then
              BACKUP_FILE="${{ env.DEPLOY_PATH }}/backups/pdfshift.db.$(date +%Y%m%d_%H%M%S)"
              sudo -u www-data cp ${{ env.DEPLOY_PATH }}/data/pdfshift.db $BACKUP_FILE
              echo "âœ… æ•°æ®åº“å·²å¤‡ä»½: $(basename $BACKUP_FILE)"
              echo "   å¤§å°: $(du -h $BACKUP_FILE | cut -f1)"
            else
              echo "âš ï¸  æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
            fi

            # ========== åœæ­¢æœåŠ¡ ==========
            echo ""
            echo "ğŸ›‘ åœæ­¢æœåŠ¡..."
            sudo systemctl stop pdfshift-api || true
            sudo systemctl stop pdfshift-worker || true
            sudo systemctl stop pdfshift-beat || true
            sleep 2
            echo "âœ… æœåŠ¡å·²åœæ­¢"

            # ========== æ›´æ–°åç«¯ä»£ç  ==========
            echo ""
            echo "ğŸ“ æ›´æ–°åç«¯ä»£ç ..."
            sudo rm -rf ${{ env.DEPLOY_PATH }}/backend.old
            if [ -d "${{ env.DEPLOY_PATH }}/backend" ]; then
              sudo mv ${{ env.DEPLOY_PATH }}/backend ${{ env.DEPLOY_PATH }}/backend.old
            fi
            sudo cp -r /tmp/deploy_package/backend ${{ env.DEPLOY_PATH }}/
            sudo chown -R www-data:www-data ${{ env.DEPLOY_PATH }}/backend
            echo "âœ… åç«¯ä»£ç å·²æ›´æ–°"

            # ========== æ›´æ–°å‰ç«¯ä»£ç  ==========
            echo ""
            echo "ğŸ¨ æ›´æ–°å‰ç«¯ä»£ç ..."
            sudo rm -rf ${{ env.DEPLOY_PATH }}/frontend/dist.old
            if [ -d "${{ env.DEPLOY_PATH }}/frontend/dist" ]; then
              sudo mv ${{ env.DEPLOY_PATH }}/frontend/dist ${{ env.DEPLOY_PATH }}/frontend/dist.old
            fi
            sudo mkdir -p ${{ env.DEPLOY_PATH }}/frontend
            sudo cp -r /tmp/deploy_package/frontend/dist ${{ env.DEPLOY_PATH }}/frontend/
            sudo chown -R www-data:www-data ${{ env.DEPLOY_PATH }}/frontend
            echo "âœ… å‰ç«¯ä»£ç å·²æ›´æ–°"

            # ========== æ›´æ–° Python ä¾èµ– ==========
            echo ""
            echo "ğŸ“š æ›´æ–° Python ä¾èµ–..."
            cd ${{ env.DEPLOY_PATH }}/backend

            if [ -f requirements.txt ]; then
              sudo -u www-data ${{ env.VENV_PATH }}/bin/pip install -r requirements.txt --upgrade --quiet
              echo "âœ… Python ä¾èµ–å·²æ›´æ–°"

              # æ˜¾ç¤ºå…³é”®åŒ…ç‰ˆæœ¬
              echo ""
              echo "ä¸»è¦ä¾èµ–ç‰ˆæœ¬:"
              sudo -u www-data ${{ env.VENV_PATH }}/bin/pip list | grep -E "fastapi|celery|redis|sqlalchemy" || true
            else
              echo "âš ï¸  æœªæ‰¾åˆ° requirements.txt"
            fi

            # ========== æ•°æ®åº“è¿ç§»ï¼ˆå¦‚éœ€è¦ï¼‰==========
            echo ""
            echo "ğŸ—„ï¸  æ£€æŸ¥æ•°æ®åº“è¿ç§»..."
            if [ -f ${{ env.DEPLOY_PATH }}/backend/migrate.py ]; then
              sudo -u www-data ${{ env.VENV_PATH }}/bin/python migrate.py
              echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"
            else
              echo "âš ï¸  æ— éœ€æ•°æ®åº“è¿ç§»"
            fi

            # ========== å¯åŠ¨æœåŠ¡ ==========
            echo ""
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            sudo systemctl start pdfshift-api
            sudo systemctl start pdfshift-worker
            sudo systemctl start pdfshift-beat

            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 5

            # ========== æ£€æŸ¥æœåŠ¡çŠ¶æ€ ==========
            echo ""
            echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."

            API_STATUS=$(sudo systemctl is-active pdfshift-api)
            WORKER_STATUS=$(sudo systemctl is-active pdfshift-worker)
            BEAT_STATUS=$(sudo systemctl is-active pdfshift-beat)

            echo "  - API:    $API_STATUS"
            echo "  - Worker: $WORKER_STATUS"
            echo "  - Beat:   $BEAT_STATUS"

            if [ "$API_STATUS" != "active" ]; then
              echo ""
              echo "âŒ API æœåŠ¡å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
              sudo journalctl -u pdfshift-api -n 30 --no-pager
              exit 1
            fi

            if [ "$WORKER_STATUS" != "active" ]; then
              echo "âš ï¸  Worker æœåŠ¡å¯åŠ¨å¼‚å¸¸"
              sudo journalctl -u pdfshift-worker -n 10 --no-pager
            fi

            # ========== å¥åº·æ£€æŸ¥ ==========
            echo ""
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."

            MAX_RETRIES=5
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -sf http://localhost/health > /dev/null 2>&1; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT+1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "â³ é‡è¯•ä¸­... ($RETRY_COUNT/$MAX_RETRIES)"
                  sleep 3
                else
                  echo ""
                  echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
                  echo ""
                  echo "API æ—¥å¿—:"
                  sudo journalctl -u pdfshift-api -n 50 --no-pager
                  echo ""
                  echo "Nginx é”™è¯¯æ—¥å¿—:"
                  sudo tail -30 /var/log/nginx/pdfshift_error.log
                  exit 1
                fi
              fi
            done

            # ========== æµ‹è¯• API ç«¯ç‚¹ ==========
            echo ""
            echo "ğŸ§ª æµ‹è¯• API ç«¯ç‚¹..."

            # æµ‹è¯•æ ¹è·¯å¾„
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/)
            if [ "$HTTP_CODE" == "200" ]; then
              echo "âœ… å‰ç«¯é¡µé¢: OK (HTTP $HTTP_CODE)"
            else
              echo "âš ï¸  å‰ç«¯é¡µé¢: HTTP $HTTP_CODE"
            fi

            # æµ‹è¯• API
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/v1/health)
            if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "404" ]; then
              echo "âœ… API ç«¯ç‚¹: OK (HTTP $HTTP_CODE)"
            else
              echo "âš ï¸  API ç«¯ç‚¹: HTTP $HTTP_CODE"
            fi

            # ========== ç³»ç»ŸçŠ¶æ€ ==========
            echo ""
            echo "ğŸ’» ç³»ç»Ÿèµ„æºä½¿ç”¨:"
            echo "  - CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')%"
            echo "  - å†…å­˜: $(free -h | awk '/^Mem:/ {print $3 "/" $2}')"
            echo "  - ç£ç›˜: $(df -h / | awk 'NR==2 {print $3 "/" $2 " (" $5 ")"}')"

            # ========== æ¸…ç† ==========
            echo ""
            echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            rm -rf /tmp/deploy.tar.gz /tmp/deploy_package

            # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™ 3 ä¸ªï¼‰
            cd ${{ env.DEPLOY_PATH }}/backups
            ls -t pdfshift.db.* 2>/dev/null | tail -n +4 | xargs -r rm

            # æ¸…ç†æ—§ä»£ç å¤‡ä»½
            sudo rm -rf ${{ env.DEPLOY_PATH }}/backend.old
            sudo rm -rf ${{ env.DEPLOY_PATH }}/frontend/dist.old

            echo "âœ… æ¸…ç†å®Œæˆ"

            # ========== å®Œæˆ ==========
            echo ""
            echo "========================================="
            echo "  âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "  æ—¶é—´: $(date)"
            echo "========================================="
            echo ""
            echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.ECS_HOST }}"
            echo "ğŸ” ç®¡ç†åå°: http://${{ secrets.ECS_HOST }}/admin"
            echo ""
            echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿—:"
            echo "  sudo journalctl -u pdfshift-api -f"
            echo "  tail -f ${{ env.DEPLOY_PATH }}/logs/api.log"
            echo ""

      # ========== 7. é€šçŸ¥éƒ¨ç½²ç»“æœ ==========
      - name: Deployment summary
        if: always()
        run: |
          echo "========================================="
          echo "Deployment Summary"
          echo "========================================="
          echo "Status: ${{ job.status }}"
          echo "Time: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "========================================="
